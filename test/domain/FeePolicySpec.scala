package domain

import java.time.{Instant, ZoneId}
import munit.FunSuite

class FeePolicySpec extends FunSuite {

  private val zone = ZoneId.of("Asia/Tokyo")
  private final case class FeeCase(name: String, start: String, end: String, expectedYen: Int)
  private def jst(s: String): Instant = Instant.parse(s"$s+09:00")

  private val feeCases = Vector(
    FeeCase("5分境界: 5分までは無料", "2026-02-19T09:00:00", "2026-02-19T09:05:00", 0),
    FeeCase("5分境界: 6分で課金開始", "2026-02-19T09:00:00", "2026-02-19T09:06:00", 200),
    FeeCase("30分境界: 平日昼30分は200円", "2026-02-19T09:00:00", "2026-02-19T09:30:00", 200),
    FeeCase("30分境界: 平日昼31分は400円", "2026-02-19T09:00:00", "2026-02-19T09:31:00", 400),
    FeeCase("60分境界: 平日夜60分は200円", "2026-02-19T18:00:00", "2026-02-19T19:00:00", 200),
    FeeCase("60分境界: 平日夜61分は400円", "2026-02-19T18:00:00", "2026-02-19T19:01:00", 400),
    FeeCase("9:00境界: 平日夜→平日昼を分割合算", "2026-02-20T08:30:00", "2026-02-20T09:30:00", 400),
    FeeCase("18:00境界: 平日昼→平日夜を分割合算", "2026-02-20T17:30:00", "2026-02-20T18:30:00", 400),
    FeeCase("0:00境界: 金曜夜→土曜夜を分割合算", "2026-02-20T23:30:00", "2026-02-21T00:30:00", 300),
    FeeCase("休日昼: 60分ごと200円", "2026-02-21T09:00:00", "2026-02-21T10:00:00", 200),
    FeeCase("休日昼: 61分で400円", "2026-02-21T09:00:00", "2026-02-21T10:01:00", 400),
    FeeCase("休日昼: 最大1800円", "2026-02-21T09:00:00", "2026-02-21T18:00:00", 1800),
    FeeCase("休日夜: 60分ごと100円", "2026-02-21T18:00:00", "2026-02-21T19:00:00", 100),
    FeeCase("休日夜: 61分で200円", "2026-02-21T18:00:00", "2026-02-21T19:01:00", 200),
    FeeCase("休日夜: 最大900円", "2026-02-21T18:00:00", "2026-02-22T09:00:00", 900),
    FeeCase("平日夜: 最大1800円", "2026-02-19T18:00:00", "2026-02-20T09:00:00", 1800)
  )

  feeCases.foreach { c =>
    test(s"料金テーブル: ${c.name}") {
      assertEquals(FeePolicy.calcFeeYen(jst(c.start), jst(c.end), zone), Right(c.expectedYen))
    }
  }

  test("料金説明文を生成できる") {
    assertEquals(
      FeePolicy.pricingSummary,
      "最初の5分無料 / 平日 昼(9:00-18:00) 30分ごと200円(上限なし) / 平日 夜(18:00-翌9:00) 60分ごと200円(最大1800円) / 休日(土日) 昼(9:00-18:00) 60分ごと200円(最大1800円) / 休日(土日) 夜(18:00-翌9:00) 60分ごと100円(最大900円)"
    )
  }
}
